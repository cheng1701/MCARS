{% comment %}
Recursive partial to render a unit node and its children for the org chart.
Requires `unit` (Unit instance) in context.
{% endcomment %}
<li class="list-group-item">
  <div class="d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      {% if unit.image %}
      <img src="{{ unit.image.url }}" alt="{{ unit.get_display_name }}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
      {% endif %}
      <div>
        <a href="{% url 'units:unit_public' unit.id %}" class="fw-semibold text-decoration-none unit-node" data-unit-id="{{ unit.id }}">
          {{ unit.get_display_name }}
        </a>
        <div class="text-muted small">
          {{ unit.get_type_display }}{% if unit.city %} Â· {{ unit.city }}{% if unit.state %}, {{ unit.state }}{% endif %}{% if unit.country %}, {{ unit.country }}{% endif %}{% endif %}
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-sm btn-outline-primary" href="{% url 'units:unit_public' unit.id %}"><i class="fas fa-eye me-1"></i> Public</a>
      {% if user.is_authenticated %}
      {% if user.is_staff or user.is_superuser or user.groups.all.0.name == 'unit_manager' %}
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'units:unit_detail' unit.id %}"><i class="fas fa-info-circle me-1"></i> Internal</a>
      {% endif %}
      {% endif %}
      <button class="btn btn-sm btn-light toggle-children" type="button" data-bs-toggle="collapse" data-bs-target="#children-{{ unit.id }}" aria-expanded="true" aria-controls="children-{{ unit.id }}">
        <i class="fas fa-chevron-down"></i>
      </button>
    </div>
  </div>
  {% with kids=unit.children.all %}
  {% if kids %}
  <div id="children-{{ unit.id }}" class="collapse show ms-4 mt-2">
    <ul class="list-group">
      {% for child in kids %}
        {% include 'units/_org_node.html' with unit=child %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% endwith %}
</li>
